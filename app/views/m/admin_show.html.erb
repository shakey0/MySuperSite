<div id="data"></div>

<%= form_tag('/m_admin', method: :post) do %>
  <%= hidden_field_tag :secret, @secret %>
  <%= text_field_tag :reply %>
  <%= submit_tag 'Submit' %>
<% end %>

<script>
  const pathParts = window.location.pathname.split('/');
  const secretFromURL = pathParts[pathParts.length - 1];

  let secret = secretFromURL;

  async function fetchDataAndUpdateDOM() {
    try {
      const response = await fetch(`/m_data?secret=${secret}`);
      if (!response.ok) throw new Error('Network response was not ok');

      const data = await response.json();

      const dataDiv = document.getElementById('data');
      
      // Clear existing content
      while (dataDiv.firstChild) {
        dataDiv.removeChild(dataDiv.firstChild);
      }

      if (data.outcome === 'success') {
        let currentConvo = null;
        
        for (let i = 0; i < data.data.convos.length; i++) {
          // Check if the convo start_time is within the last hour or if not seen
          const convoStartTime = Date.parse(data.data.convos[i].start_time.replace(" ", "T"));
          
          if (convoStartTime > Date.now() - 3600000 || data.data.convos[i].seen === false) {
            currentConvo = data.data.convos[i].messages;
            break;
          }
        }

        if (currentConvo !== null) {
          currentConvo.forEach(item => {
            const itemElement = document.createElement('p');
            itemElement.textContent = item.message;
            dataDiv.appendChild(itemElement);
          });
        } else {
          const itemElement = document.createElement('p');
          itemElement.textContent = 'No messages in the last hour';
          dataDiv.appendChild(itemElement);
        }
      } else {
        const itemElement = document.createElement('p');
        itemElement.textContent = "That's not a secret code.";
        itemElement.style.color = 'red';
        dataDiv.appendChild(itemElement);
      }
    } catch (error) {
      console.error('Error fetching data:', error);
      const itemElement = document.createElement('p');
      itemElement.textContent = "Sorry, something went wrong. Please try again.";
      itemElement.style.color = 'red';
      dataDiv.appendChild(itemElement);
    }
  }

  setInterval(fetchDataAndUpdateDOM, 2000);

  fetchDataAndUpdateDOM();
</script>
